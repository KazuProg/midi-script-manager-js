!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MIDIScriptManager=t()}(this,(function(){"use strict";const e={Note:"n",ControlChange:"c",CC:"c",RawNoteOff:128,RawNoteOn:144,RawControlChange:176};class t{#e;#t;#i;#s;#a=null;#n=null;#r=null;#o;constructor(e,t,i,s,a,n={}){this.#e=e,this.#t=t,this.#i=i,this.#s=s,this.#a=n?.name||null,this.#n=n?.script?.name||null,this.#r=n?.script?.code||null,this.#o=a}get device(){return this.#e}get type(){return this.#t}get channel(){return this.#i}get number(){return this.#s}get defaultName(){let t;switch(this.type){case e.Note:t=this.#c(this.#s);break;case e.CC:t=`0x${this.#s.toString(16).toUpperCase().padStart(2,"0")}`}return t}get name(){return null!==this.#a?this.#a:this.defaultName}get isDefaultName(){return null===this.#a}get scriptName(){return this.scriptCode?this.#n||"No Name":null}get scriptCode(){return this.#r}set name(e){""===(e=e.trim())&&(e=null),this.#a=e,this.#o()}set scriptName(e){""===(e=e.trim())&&(e=null),this.#n=e,this.#o()}set scriptCode(e){""===(e=e.trim())?(this.#n=null,this.#r=null):this.#r=e.trim(),this.#o()}executeScript(e={}){if(this.#r)try{new Function(...Object.keys(e),this.#r)(...Object.values(e))}catch(e){console.error("An error occurred while executing the custom script:",e)}}get midiID(){return this.type+((this.channel<<8)+this.number).toString(16)}toJSON(){const e={midi:this.midiID,name:this.name};return this.#r&&(e.script={name:this.#n,code:this.#r}),e}#c(e){const t="C|C#|D|D#|E|F|F#|G|G#|A|A#|B".split("|"),i=Math.floor(e/12)-1;return`${t[e%12]}${i}`}}class i{#d;#h;#o;#l;#m;constructor(t,i,s,a={}){this.#d=t,this.#d.onmidimessage=this.#p.bind(this),this.#h=i,this.#o=s,this.#l={executeScript:!1,onMessage:null,data:null,...a},this.#m={[e.Note]:Array.from({length:16},(()=>[])),[e.CC]:Array.from({length:16},(()=>[]))},this.#l.data&&this.applyMappings(this.#l.data.mappings)}applyMappings(e){if(e)for(const i of e){const e=i.midi.substr(0,1),s=parseInt(i.midi.substr(1,1),16),a=parseInt(i.midi.substr(2,2),16),n=new t(this,e,s,a,this.#u.bind(this),i);e in this.#m&&(this.#m[e][s][a]=n)}}get name(){return this.#d.name}get manufacturer(){return this.#d.manufacturer}get serviceName(){return this.#h}get noteElements(){return this.#m[e.Note]}get ccElements(){return this.#m[e.CC]}get elements(){return[...this.noteElements.flat(),...this.ccElements.flat()]}findElementById(e){return this.elements.find((t=>t.midiID===e))}#p(i){const[s,a,n]=i.data,r=15&s;let o;switch(240&s){case e.RawNoteOn:case e.RawNoteOff:o=e.Note;break;case e.RawControlChange:o=e.CC;break;default:return}const c=this.#m[o];c[r][a]||(c[r][a]=new t(this,o,r,a,this.#u.bind(this)),this.#u());const d=c[r][a];if(this.#l.onMessage){const e={raw:i.data,status:s,data1:a,data2:n,type:o,channel:r};this.#l.onMessage(this,d,e)}this.#l.executeScript&&d.executeScript({status:s,data1:a,data2:n,type:o,channel:r,number:a,value:n,val:n/127})}#u(){this.#o(this)}toJSON(){return{device:{name:this.name,manufacturer:this.manufacturer},service:this.#h,mappings:this.elements.map((e=>e.toJSON()))}}}class s{#g;constructor(e){this.#g=e}load(){return new Promise(((e,t)=>{e(JSON.parse(localStorage.getItem(this.#g)))}))}save(e){localStorage.setItem(this.#g,JSON.stringify(e))}}class a{#v;#f;constructor(e,t){this.#v=e,this.#f=t}load(){return new Promise(((e,t)=>{const i=t=>{t.origin===this.#v&&t.data.sender&&t.data.sender===this.#f&&(window.removeEventListener("message",i),e(t.data.data))};window.addEventListener("message",i),window.opener.postMessage({sender:this.#f,data:"requestData"},this.#v)}))}save(e){window.opener.postMessage({sender:this.#f,data:e},this.#v)}}class n{#w;#C;constructor(e){const t=new URLSearchParams(window.location.search).get("targetOrigin");if(window.opener&&t){this.#w=new a(t,e.postMessageKey);try{window.opener.addEventListener("beforeunload",(()=>{window.close()}))}catch(e){console.log(e)}}else this.#w=new s(e.localStorageKey),window.addEventListener("storage",(t=>{t.key===e.localStorageKey&&(this.#C=JSON.parse(t.newValue)||[])}));this.#w.load().then((e=>{this.#C=e||[]}))}loadAll(){return this.#C}load(e,t,i){return this.#C.find((s=>s.device.name===e&&s.device.manufacturer===t&&s.service===i))}save(e){if(!e instanceof i)throw new Error("Invalid device type");this.saveObject(e.toJSON())}saveObject(e){if(!this.isValidKeymapObject(e))throw new Error("The format of the key mapping object is invalid.");const t=this.#C.find((t=>t.device.name===e.device.name&&t.device.manufacturer===e.device.manufacturer&&t.service===e.service));t?Object.assign(t,e):this.#C.push(e),this.#w.save(this.#C)}isValidKeymapObject(e){return"object"==typeof e&&null!==e&&("string"==typeof e.device?.name&&"string"==typeof e.device?.manufacturer&&("string"==typeof e.service&&!!Array.isArray(e.mappings)))}}class r{static MessageTypes=e;static scriptOrigin;#h;#l={};#y=[];#N;constructor(e,t={}){this.#h=e,this.#l={localStorageKey:"midi-scripts",postMessageKey:"MIDIScriptManager",executeScript:!1,onMessage:null,onDeviceChange:null,...t},this.#N=new n(this.#l)}get devices(){return this.#y}async requestAccess(){if(!navigator.requestMIDIAccess)throw new Error("Web MIDI API is not supported in this browser.");try{const e=await navigator.requestMIDIAccess();e.onstatechange=e=>{"input"===e.port.type&&this.#b(e.port)},e.inputs.forEach((e=>{this.#b(e)}))}catch(e){throw new Error(`Failed to request MIDI access: ${e.message}`)}}findDevice(e,t){return this.#y.find((i=>i.name===e&&i.manufacturer===t))}openCustomScriptEditor(){const e=`${r.scriptOrigin}/midi-script-manager-js/custom-script-editor/`,t=new URLSearchParams({service:this.#h,targetOrigin:location.origin}),i=window.open(`${e}?${t.toString()}`,"CustomScriptEditor","width=640,height=720");window.addEventListener("message",(e=>{if(e.origin===r.scriptOrigin&&"MIDIScriptManager"===e.data.sender){const t=e.data.data;if("requestData"===t)return void i.postMessage({sender:"MIDIScriptManager",data:this.#N.loadAll()},r.scriptOrigin);for(const e of t)this.importKeymapObject(e)}}))}importKeymapObject(e){this.#N.saveObject(e);const t=this.findDevice(e.device.name,e.device.manufacturer);t&&t.applyMappings(e.mappings)}#b(e){const t=this.findDevice(e.name,e.manufacturer);if(t&&this.#y.splice(this.#y.indexOf(t),1),"connected"===e.state){const t=new i(e,this.#h,this.#I.bind(this),{...this.#l,data:this.#N.load(e.name,e.manufacturer,this.#h)});this.#y.push(t),this.#l.onDeviceChange&&this.#l.onDeviceChange(t)}}#I(e){this.#N.save(e)}}if(document.currentScript&&document.currentScript.src){const e=document.currentScript.src,t=new URL(e).origin;r.scriptOrigin=t}else r.scriptOrigin="https://kazuprog.github.io";return r}));
