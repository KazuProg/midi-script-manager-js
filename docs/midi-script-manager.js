!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MIDIScriptManager=t()}(this,(function(){"use strict";const e={NoteOff:128,NoteOn:144,ControlChange:176};class t{#e;#t;#s;#i=null;#n=null;#a=null;#r;constructor(e,t,s,i,n={}){this.#e=e,this.#t=t,this.#s=s,this.#i=n?.name||null,this.#n=n?.script?.name||null,this.#a=n?.script?.code||null,this.#r=i}get device(){return this.#e}get messageType(){return 240&this.#t}get channel(){return 15&this.#t}get number(){return this.#s}get defaultName(){let t;switch(this.messageType){case e.NoteOff:case e.NoteOn:t=this.#o(this.#s);break;case e.ControlChange:t=`0x${this.#s.toString(16).toUpperCase().padStart(2,"0")}`}return t}get name(){return null!==this.#i?this.#i:this.defaultName}get isDefaultName(){return null===this.#i}get scriptName(){return this.scriptCode?this.#n||"No Name":null}get scriptCode(){return this.#a}set name(e){""===(e=e.trim())&&(e=null),this.#i=e,this.#r()}set scriptName(e){""===(e=e.trim())&&(e=null),this.#n=e,this.#r()}set scriptCode(e){""===(e=e.trim())?(this.#n=null,this.#a=null):this.#a=e.trim(),this.#r()}executeScript(e={}){if(this.#a)try{new Function(...Object.keys(e),this.#a)(...Object.values(e))}catch(e){console.error("An error occurred while executing the custom script:",e)}}get midiID(){return((this.#t<<8)+this.#s).toString(16)}toJSON(){const e={midi:this.midiID,name:this.name};return this.#a&&(e.script={name:this.#n,code:this.#a}),e}#o(e){const t="C|C#|D|D#|E|F|F#|G|G#|A|A#|B".split("|"),s=Math.floor(e/12)-1;return`${t[e%12]}${s}`}}class s{#c;#h;#r;#d=[];#m=[];#l={};constructor(e,t,s,i={}){this.#c=e,this.#c.onmidimessage=this.#u.bind(this),this.#h=t,this.#r=s,this.#l={executeScript:!1,onMessage:null,data:null,...i},this.#l.data&&this.applyMappings(this.#l.data.mappings)}applyMappings(s){if(s)for(const i of s){const s=parseInt(i.midi,16),n=new t(this,(65280&s)>>8,255&s,this.#p.bind(this),i);n.messageType===e.NoteOn||n.messageType===e.NoteOff?(this.#d[n.channel]||(this.#d[n.channel]=[]),this.#d[n.channel][n.number]=n):n.messageType===e.ControlChange&&(this.#m[n.channel]||(this.#m[n.channel]=[]),this.#m[n.channel][n.number]=n)}}get name(){return this.#c.name}get manufacturer(){return this.#c.manufacturer}get serviceName(){return this.#h}get noteElements(){return this.#d}get ccElements(){return this.#m}get elements(){return[...this.#d.flat(),...this.#m.flat()]}findElementById(e){return this.elements.find((t=>t.midiID===e))}#u(s){const[i,n,a]=s.data,r=240&i,o=15&i;let c=null;switch(r){case e.NoteOn:case e.NoteOff:c=this.#d;break;case e.ControlChange:c=this.#m;break;default:return}c[o]||(c[o]=[]),c[o][n]||(c[o][n]=new t(this,i,n,this.#p.bind(this)),this.#p());const h=c[o][n];if(this.#l.onMessage){const e={raw:s.data,status:i,data1:n,data2:a,messageType:r,channel:o};this.#l.onMessage(this,h,e)}this.#l.executeScript&&h.executeScript({status:i,data1:n,data2:a,messageType:r,channel:o,number:n,value:a,val:a/127})}#p(){this.#r(this)}toJSON(){return{device:{name:this.name,manufacturer:this.manufacturer},service:this.#h,mappings:[...this.#d.flat().map((e=>e.toJSON())),...this.#m.flat().map((e=>e.toJSON()))]}}}class i{#g;constructor(e){this.#g=e}load(){return new Promise(((e,t)=>{e(JSON.parse(localStorage.getItem(this.#g)))}))}save(e){localStorage.setItem(this.#g,JSON.stringify(e))}}class n{#v;#f;constructor(e,t){this.#v=e,this.#f=t}load(){return new Promise(((e,t)=>{const s=t=>{t.origin===this.#v&&t.data.sender&&t.data.sender===this.#f&&(window.removeEventListener("message",s),e(t.data.data))};window.addEventListener("message",s),window.opener.postMessage({sender:this.#f,data:"requestData"},this.#v)}))}save(e){window.opener.postMessage({sender:this.#f,data:e},this.#v)}}class a{#N;#w;constructor(e){const t=new URLSearchParams(window.location.search).get("targetOrigin");window.opener&&t?(this.#N=new n(t,e.postMessageKey),window.opener.addEventListener("beforeunload",(()=>{window.close()}))):(this.#N=new i(e.localStorageKey),window.addEventListener("storage",(t=>{t.key===e.localStorageKey&&(this.#w=JSON.parse(t.newValue)||[])}))),this.#N.load().then((e=>{this.#w=e||[]}))}loadAll(){return this.#w}load(e,t,s){return this.#w.find((i=>i.device.name===e&&i.device.manufacturer===t&&i.service===s))}save(e){if(!e instanceof s)throw new Error("Invalid device type");this.saveObject(e.toJSON())}saveObject(e){const t=this.#w.find((t=>t.device.name===e.device.name&&t.device.manufacturer===e.device.manufacturer&&t.service===e.service));t?Object.assign(t,e):this.#w.push(e),this.#N.save(this.#w)}}class r{static MessageTypes=e;static scriptOrigin;#h;#l={};#I=[];#C;constructor(e,t={}){this.#h=e,this.#l={localStorageKey:"midi-scripts",postMessageKey:"MIDIScriptManager",executeScript:!1,onMessage:null,onDeviceChange:null,...t},this.#C=new a(this.#l)}get devices(){return this.#I}async requestAccess(){if(!navigator.requestMIDIAccess)throw new Error("Web MIDI API is not supported in this browser.");try{const e=await navigator.requestMIDIAccess();e.onstatechange=e=>{"input"===e.port.type&&this.#b(e.port)},e.inputs.forEach((e=>{this.#b(e)}))}catch(e){throw new Error(`Failed to request MIDI access: ${e.message}`)}}findDevice(e,t){return this.#I.find((s=>s.name===e&&s.manufacturer===t))}openCustomScriptEditor(){const e=`${r.scriptOrigin}/midi-script-manager-js/custom-script-editor/`,t=new URLSearchParams({service:this.#h,targetOrigin:location.origin}),s=window.open(`${e}?${t.toString()}`,"CustomScriptEditor","width=640,height=720");window.addEventListener("message",(e=>{if(e.origin===r.scriptOrigin&&"MIDIScriptManager"===e.data.sender){const t=e.data.data;if("requestData"===t)return void s.postMessage({sender:"MIDIScriptManager",data:this.#C.loadAll()},r.scriptOrigin);for(const e of t)this.importKeymapObject(e)}}))}importKeymapObject(e){this.#C.saveObject(e);const t=this.findDevice(e.device.name,e.device.manufacturer);t&&t.applyMappings(e.mappings)}#b(e){const t=this.findDevice(e.name,e.manufacturer);if(t&&this.#I.splice(this.#I.indexOf(t),1),"connected"===e.state){const t=new s(e,this.#h,this.#M.bind(this),{...this.#l,data:this.#C.load(e.name,e.manufacturer,this.#h)});this.#I.push(t),this.#l.onDeviceChange&&this.#l.onDeviceChange(t)}}#M(e){this.#C.save(e)}}if(document.currentScript&&document.currentScript.src){const e=document.currentScript.src,t=new URL(e).origin;r.scriptOrigin=t}else r.scriptOrigin="https://kazuprog.github.io";return r}));
